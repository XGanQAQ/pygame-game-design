# 开发日志

## 2025/4/22 czg
开发测试蛇的网格系统，测试一半，没测试完，发现蛇的网格系统有问题

## 2025/4/29 snake_grid 与 intvector2
在测试蛇的网格系统
遇到一个问题，vector2是线性的，不能用来做网格系统
需要一个只允许整数的vector2

我手动编写了一个名为IntVector2的类，来实现这个功能
这个类的实现很简单，只有两个整数x和y，和一些基本的运算符重载

测试完成了snake_grid的实现

## 2025/5/6 实现所有层的基本运行
实现了所有层的基本实现，初步的GameMapManager也实现了。
但是snake对于移动碰撞到对应层的对应物体的检测尚未添加

待实现
- snake_grid碰撞到对应层的对应物体的检测
    - 最好是能封装成一个函数，用来检测，需要方便后期的扩展
- snake_grid的fall函数
    - 在update函数中，snake_grid的fall函数会被调用
    - 包装蛇一定在平台上，或者在物体上。

## 2025/5/8 完善snake_grid
已完成
- 添加更多的碰撞检测函数
- 添加snake_grid的fall函数

待做
- 实现地图读取控制器
- Game测试

地图生成可选方案  
- 直接在代码中写死地图
    - 需要一大段文本代码来实现地图的生成，直接编写在代码中
- 读取地图文件，解析成对应的层
    - 多个层拼接在一起，随机生成对应的层
- 算法生成地图

首先游戏每一行的网格长度要提前指定好，不然编写的地图文件读取进去会不正确。
地图绘制要考虑到玩家是否能够通过此层。

策划：设计地图大概是什么样->程序：参考策划的设计，设计编写规范
策划：按照规范编写地图文件->程序：读取地图文件，解析成对应的层

## 2025/5/20 简单的地图读取
地图读取格式，采用文本地图，对应数字代表对应物体
现有的物体
- 0：空地
- 10 代表不可穿透的地面
- 50 代表苹果
由于物体为0-99，所以一个元素占用两位字符，每个元素之间以空格隔开。

先用.txt文件来实现
解析的时候跳过空行（每10行空一行，方便编写观察）
第一行是地图的宽度
第二行是地图的高度
第三行是地图的内容
```
20
20
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  50 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
10 10 10 10 10 0  0  0  0  0  0  0  10 10 10 10 10 0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  10 10 10 10 10 0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  50 

0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  50 0  0  0  0  0  0  0  0  0  0  0  50 0  0  0  0  0  
10 10 10 10 10 0  0  0  0  0  0  0  10 10 10 10 10 0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  50 0  0  0  50 0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  10 10 10 10 10 0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  
```

## 2025/5/27 
计划
- [x]将已经开发的体系融入Game
- [ ]实现更多的物体效果
- [ ]导入美术资源测试
- [ ]添加控制蛇的速度的功能

执行
（前几天）合并了音乐管理器
成功将GameMapManager融入Game
但是由于缺少了clock.tick(10)对于游戏更新速度的限制，游戏更新的速度比较快，我需要给蛇添加一个限制，实现能够控制其速度

杂谈
Game类作为游戏运行的核心，实现游戏生命周期的循环，并不在其中实现具体某个游戏逻辑，而是在main函数中去通过注册事件来将游戏对象的逻辑加入到游戏循环中。

## 2025/5/28 添加控制蛇的速度的功能

计划
- [x]将已经开发的体系融入Game
- [x]实现更多的物体效果
    - [x]实现苹果效果50
    - [x]实现浮空药水51
    - [x]实现无敌星星52
    - [x]实现加速药水53
- [ ]导入美术资源测试
- [x]添加控制蛇的速度的功能

修复
- [ ]修复下落的适合的显示不正常的BUG
    - 发现问题：不是draw绘制的问题，是因为在蛇既要移动，又要坠落的逻辑尝试了冲突，导致了中断。
    - 研究问题：

## 2025/5/29 

计划
- [x]导入美术资源测试
- [ ]添加游戏UI
    - [ ] 启动界面
    - [ ] 游戏界面
    - [ ] 结束界面
- [x]设置地图滚动速度
- [x]将snake同样加入滚动逻辑
- [ ]完善层级的滚动逻辑，应该是有一个存储整个读取的地图，一个存储当前显示的地图，滚动之后，将后续的地图读取出来，替换当前显示的地图的最上层。

修复
- [x]修复下落的适合的显示不正常的BUG
    - 发现问题：不是draw绘制的问题，是因为在蛇既要移动，又要坠落的逻辑尝试了冲突，导致了中断。
    - 研究问题：分析发现是因为下落的逻辑是一个一个遍历擦除绘制
    - 解决问题：修改为先遍历擦除，再遍历绘制，修复了下落的显示不正常的BUG

## 2025/5/31

计划
- [ ]添加游戏UI
    - [ ] 启动界面
    - [ ] 游戏界面
    - [ ] 结束界面
- [ ]完善层级的滚动逻辑，应该是有一个存储整个读取的地图，一个存储当前显示的地图，滚动之后，将后续的地图读取出来，替换当前显示的地图的最上层。
- [ ]关卡编辑器，策划手写的关卡根本不符合格式，需要一个关卡编辑器，

## 2025/6/3

计划
- [ ]添加游戏UI
    - [ ] 字体资源
    - [ ] 学习pygame的ui
    - [ ] 启动界面
    - [ ] 游戏界面
    - [ ] 结束界面
- [x]滚动读取——完善层级的滚动逻辑，应该是有一个存储整个读取的地图，一个存储当前显示的地图，滚动之后，将后续的地图读取出来，替换当前显示的地图的最上层。
- [x]关卡编辑器，策划手写的关卡根本不符合格式，需要一个关卡编辑器，
    - [x]csv关卡编辑器

BUG
- [ ]下落开启时，蛇的网格更新逻辑有问题，回出现不正确的蛇身和蛇头
研究发现：是蛇的下落逻辑存在问题，正常网格的下落是基于基类push，但是蛇因为存在移动更新，移动更新额外维护了蛇身和蛇头的坐标，并基于此属性进行绘制。
如何修复：
- 将移动逻辑修改为不依赖维护蛇身和蛇头的坐标，而是每轮重新遍历（*不可行*，没有状态无法保存蛇的运行轨迹）
- 将下落逻辑重写，在下落的时候，修改蛇身和蛇头的坐标（保证对蛇身和蛇头的坐标的维护）。


执行
- [x]滚动读取
如何实现关卡的分段读取
因为关卡的高度大于屏幕，所以需要分段读取。
初始化：第一步是读取屏幕高度的关卡，从读取的关卡的最底层填充到现有显示的网格的最上层，初始化的时候进行 屏幕高度/蛇的网格大小=需要读取的层数 的读取，就相对于初始化了.
滚动读取：地图下滚一次，将读取数据的最上层推送到网格的最上层。
现在的问题是：
- 读取关卡为将读取数据直接遍历复制到关卡网格
- 读取滚动为（忽略蛇）自身的方法向下滚动
应该的修改：
- 统一的读取函数，推进新的一层，后一层向后
- 读取滚动为按时间，roll推入新的一层
如何实现
- gridmap基类原来的二维数组的基础上，添加队列的函数逻辑
    - push函数，参数为一维数组，代表新的一层数据，将数据推入数据层顶
        - 所有数据先向下移动一格
        - 将新的一层数据填入数据层顶
    - pop函数，将数据底层弹出
        - 擦除最底层数据

## 2025/6/4 
计划
- [ ]添加游戏UI
    - [ ] 字体资源
    - [ ] 学习pygame的ui
    - [ ] 启动界面
    - [ ] 游戏界面
    - [ ] 结束界面

BUG
- [x]下落开启时，蛇的网格更新逻辑有问题，回出现不正确的蛇身和蛇头
研究发现：是蛇的下落逻辑存在问题，正常网格的下落是基于基类push，但是蛇因为存在移动更新，移动更新额外维护了蛇身和蛇头的坐标，并基于此属性进行绘制。
状态观察：蛇在静止的时候不会出现错误，而移动时会出现，尤其是竖向身体的时候
混乱之源：在调整蛇的状态的时候，使用set_cell直接进行修改擦除，导致对于其head,body,tail状态混乱
如何修复：
- 将移动逻辑修改为不依赖维护蛇身和蛇头的坐标，而是每轮重新遍历（*不可行*，没有状态无法保存蛇的运行轨迹）
- 将下落逻辑重写，在下落的时候，修改蛇身和蛇头的坐标（保证对蛇身和蛇头的坐标的维护）。
重构：
基于蛇的队列为核心
蛇：队列
蛇头：队列的第一个元素
蛇身：队列的中间元素
蛇尾：队列的倒数第一个元素
蛇的移动：队列头添加一个移动方向的元素，队列尾删除一个元素
蛇的移动后吃到苹果增长了长度：预留蛇尾的坐标，执行蛇的移动，移动完之后，队列入队预留的坐标。
蛇的下落：队列的所有元素向下移动一格
蛇图的滚动：队列的所有元素向下移动一格
蛇的更新：执行蛇的移动，蛇的下落，并把蛇的队列，映射到蛇图的二维数组。
蛇的绘制：遍历蛇图的二维数组，绘制蛇图。

## 2025/6/7 
计划
- [ ]添加游戏UI
    - [x] 引入pygame_gui
    - [ ] 字体资源
    - [x] 学习pygame_gui
    - [ ] ui_canvas
        - [ ] 点击开始游戏
        - [ ] 死亡弹窗界面
- [ ]让游戏实际可以玩
    - [x]通关
    - [x]死亡信号
- [x]加入新的美术资源
- [ ]关卡管理器

日志
我大概了解了pygame_gui的使用，接下来需要封装成canvas，在Game中调用更新和绘制。

## 2025/6/9 UI管理器
计划
- [ ]添加游戏UI
    - [x] 字体资源
    - [x] ui_canvas
        - [x] 按下空格开始游戏
        - [ ] 死亡弹窗界面
- [x]让游戏实际可以玩
- [ ]关卡管理器
- [x]将game_map_manager的event提到event上

BUG
- [x]大关卡读取存在问题
    - [x] 蛇的身体初始长度设置
其实是因为管卡绘制使用了11，而我实际没有写上去

日志
蛇的默认移动速度是500，掉落速度是500

测试
- 不做：关卡下滚卡
- 美术：刺的四面八方
- 浮空穿墙BUG
- 结束死亡界面弹出
- 碰到刺不直接死亡

